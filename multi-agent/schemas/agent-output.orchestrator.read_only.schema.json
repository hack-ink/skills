{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "file:///.codex/agent-output-orchestrator-read-only.schema.json",
	"title": "Codex Orchestrator Output (Read Only)",
	"description": "Structural schema for orchestrator outputs that report completion of read_only subtasks. Read-only workflows may dispatch non-coding Operator slices; coding leaves are `coder_spark` (fallback `coder_codex`).",
	"type": "object",
	"required": [
		"ssot_id",
		"protocol_version",
		"task_id",
		"subtask_id",
		"agent_type",
		"workflow_mode",
		"routing_mode",
		"slice_id",
		"coder_subtask_ids",
		"operator_subtask_ids",
		"parallel_peak_inflight",
		"dispatch_plan",
		"review_phases",
		"status",
		"blocked",
		"rationale",
		"review_only",
		"blocking_reason",
		"allowed_paths",
		"review_loop"
	],
	"$defs": {
		"task_contract": {
			"type": "object",
			"required": [
				"goal",
				"scope",
				"constraints",
				"expected_output",
				"non_goals",
				"writes_repo"
			],
			"properties": {
				"goal": {
					"type": "string",
					"minLength": 1
				},
				"scope": {
					"type": "string",
					"minLength": 1
				},
				"constraints": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				},
				"expected_output": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				},
				"non_goals": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				},
				"writes_repo": {
					"type": "boolean"
				}
			},
			"additionalProperties": false
		}
	},
	"properties": {
		"ssot_id": {
			"type": "string",
			"minLength": 1
		},
		"protocol_version": {
			"type": "string",
			"const": "2.0"
		},
		"task_id": {
			"type": "string",
			"minLength": 1
		},
		"subtask_id": {
			"type": "string",
			"minLength": 1
		},
		"agent_type": {
			"type": "string",
			"const": "orchestrator"
		},
		"workflow_mode": {
			"type": "string",
			"enum": ["parallel_dispatch", "subagent_task_execution", "mixed"]
		},
		"routing_mode": {
			"type": "string",
			"const": "assistant_nested"
		},
		"slice_id": {
			"type": "string",
			"minLength": 1
		},
		"coder_subtask_ids": {
			"type": "array",
			"items": {
				"type": "string",
				"minLength": 1
			}
		},
		"operator_subtask_ids": {
			"type": "array",
			"items": {
				"type": "string",
				"minLength": 1
			}
		},
		"parallel_peak_inflight": {
			"type": "integer",
			"minimum": 0
		},
		"dispatch_plan": {
			"type": "object",
			"required": ["independence_assessment", "windowing", "slices"],
			"properties": {
				"independence_assessment": {
					"type": "object",
					"required": ["conflict_policy", "domains"],
					"properties": {
						"conflict_policy": {
							"type": "string",
							"const": "ownership_lock"
						},
						"domains": {
							"type": "array",
							"minItems": 1,
							"items": {
								"type": "object",
								"required": ["domain_id", "description", "can_parallelize"],
								"properties": {
									"domain_id": {
										"type": "string",
										"minLength": 1
									},
									"description": {
										"type": "string",
										"minLength": 1
									},
									"can_parallelize": {
										"type": "boolean"
									},
									"shared_state_risks": {
										"type": "array",
										"items": {
											"type": "string",
											"minLength": 1
										}
									}
								},
								"additionalProperties": false
							}
						}
					},
					"additionalProperties": false
				},
				"windowing": {
					"type": "object",
					"required": ["plan", "window_size", "wait_strategy"],
					"properties": {
						"plan": {
							"type": "string",
							"const": "windowed"
						},
						"window_size": {
							"type": "integer",
							"minimum": 1
						},
						"wait_strategy": {
							"type": "string",
							"enum": ["functions.wait"]
						}
					},
					"additionalProperties": false
				},
				"slices": {
					"type": "array",
					"minItems": 1,
					"items": {
						"type": "object",
						"required": [
							"leaf_subtask_id",
							"leaf_agent_type",
							"domain_id",
							"ownership_paths",
							"task_contract"
						],
						"properties": {
							"leaf_subtask_id": {
								"type": "string",
								"minLength": 1
							},
							"leaf_agent_type": {
								"type": "string",
								"enum": ["coder_spark", "coder_codex", "operator"]
							},
							"domain_id": {
								"type": "string",
								"minLength": 1
							},
							"ownership_paths": {
								"type": "array",
								"minItems": 1,
								"items": {
									"type": "string",
									"minLength": 1,
									"pattern": "^(/|web:|repo:)"
								}
							},
							"task_contract": {
								"$ref": "#/$defs/task_contract"
							}
						},
						"additionalProperties": false
					}
				}
			},
			"additionalProperties": false
		},
		"review_phases": {
			"type": "array",
			"minItems": 2,
			"maxItems": 2,
			"prefixItems": [
				{
					"type": "object",
					"required": ["phase", "status", "notes"],
					"properties": {
						"phase": {
							"type": "string",
							"const": "dispatch_safety"
						},
						"status": {
							"type": "string",
							"enum": ["pass", "fail"]
						},
						"notes": {
							"type": "string",
							"minLength": 1
						}
					},
					"additionalProperties": false
				},
				{
					"type": "object",
					"required": ["phase", "status", "notes"],
					"properties": {
						"phase": {
							"type": "string",
							"const": "finalization"
						},
						"status": {
							"type": "string",
							"enum": ["pass", "fail"]
						},
						"notes": {
							"type": "string",
							"minLength": 1
						}
					},
					"additionalProperties": false
				}
			],
			"items": false
		},
		"status": {
			"type": "string",
			"enum": ["in_progress", "done", "awaiting_review"]
		},
		"blocked": {
			"type": "boolean"
		},
		"rationale": {
			"type": "string",
			"minLength": 1
		},
		"review_only": {
			"type": "boolean"
		},
		"blocking_reason": {
			"type": "string",
			"minLength": 1
		},
		"allowed_paths": {
			"type": "array",
			"minItems": 1,
			"items": {
				"type": "string",
				"minLength": 1,
				"pattern": "^(/|web:|repo:)"
			}
		},
		"review_loop": {
			"type": "object",
			"required": [
				"policy",
				"self_passes",
				"converged",
				"new_issues_found_in_last_self_pass",
				"escalation_reason"
			],
			"properties": {
				"policy": {
					"type": "string",
					"const": "adaptive_min2_max3_second_pass_stable"
				},
				"self_passes": {
					"type": "integer",
					"minimum": 2
				},
				"converged": {
					"type": "boolean"
				},
				"new_issues_found_in_last_self_pass": {
					"type": "boolean"
				},
				"escalation_reason": {
					"type": "string",
					"minLength": 1
				}
			},
			"additionalProperties": false
		}
	},
	"allOf": [
		{
			"oneOf": [
				{
					"properties": {
						"status": {
							"const": "awaiting_review"
						},
						"blocked": {
							"const": true
						}
					}
				},
				{
					"allOf": [
						{
							"properties": {
								"status": {
									"enum": ["in_progress", "done"]
								}
							}
						},
						{
							"properties": {
								"blocked": {
									"const": false
								}
							}
						}
					]
				}
			]
		},
		{
			"if": { "properties": { "blocked": { "const": false } } },
			"then": { "properties": { "blocking_reason": { "const": "not_applicable" } } }
		},
		{
			"if": { "properties": { "blocked": { "const": true } } },
			"then": {
				"properties": { "blocking_reason": { "not": { "const": "not_applicable" } } }
			}
		},
		{
			"if": { "properties": { "status": { "const": "done" } } },
			"then": {
				"properties": {
					"review_loop": { "properties": { "converged": { "const": true } } }
				}
			}
		}
	],
	"examples": [
		{
			"ssot_id": "dev-9f2c0d6a1b3e",
			"protocol_version": "2.0",
			"task_id": "task-brief-001",
			"subtask_id": "s1-brief",
			"agent_type": "orchestrator",
			"workflow_mode": "parallel_dispatch",
			"routing_mode": "assistant_nested",
			"slice_id": "slice-orchestrate-prework-a",
			"coder_subtask_ids": [],
			"operator_subtask_ids": ["op-brief-1"],
			"parallel_peak_inflight": 0,
			"dispatch_plan": {
				"independence_assessment": {
					"conflict_policy": "ownership_lock",
					"domains": [
						{
							"domain_id": "brief",
							"description": "Prework brief generation",
							"can_parallelize": false,
							"shared_state_risks": ["No coders dispatched in this slice"]
						}
					]
				},
				"windowing": {
					"plan": "windowed",
					"window_size": 1,
					"wait_strategy": "functions.wait"
				},
				"slices": [
					{
						"leaf_subtask_id": "op-brief-1",
						"leaf_agent_type": "operator",
						"domain_id": "brief",
						"ownership_paths": ["/abs/repo"],
						"task_contract": {
							"goal": "Produce a coder-ready execution brief for the requested change.",
							"scope": "Read-only analysis; no repo writes.",
							"constraints": ["Do not modify files"],
							"expected_output": [
								"A concise brief with file paths and acceptance criteria"
							],
							"non_goals": ["No implementation"],
							"writes_repo": false
						}
					}
				]
			},
			"review_phases": [
				{
					"phase": "dispatch_safety",
					"status": "pass",
					"notes": "No concurrent coders; no ownership conflicts."
				},
				{
					"phase": "finalization",
					"status": "pass",
					"notes": "Read-only orchestrator slice finalized."
				}
			],
			"status": "done",
			"blocked": false,
			"rationale": "REVIEW_ONLY: Orchestrator prework completed.",
			"review_only": true,
			"blocking_reason": "not_applicable",
			"allowed_paths": ["/abs/runtime/.codex/dispatch-preflight.schema.json"],
			"review_loop": {
				"policy": "adaptive_min2_max3_second_pass_stable",
				"self_passes": 2,
				"converged": true,
				"new_issues_found_in_last_self_pass": false,
				"escalation_reason": "none"
			}
		}
	],
	"additionalProperties": false
}
