{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "file:///.codex/dispatch-preflight.schema.json",
	"title": "Codex Dispatch Preflight",
	"description": "Structural schema for Director Dispatch Preflight JSON. Cross-field/runtime invariants are enforced by AGENTS.md.",
	"type": "object",
	"required": [
		"ssot_id",
		"protocol_version",
		"workflow_mode",
		"task_kind",
		"sizing",
		"routing_decision",
		"ssot",
		"routing_mode",
		"subtasks",
		"scheduler_plan",
		"review_policy",
		"parallel_policy"
	],
	"properties": {
		"ssot_id": {
			"type": "string",
			"minLength": 1
		},
		"protocol_version": {
			"type": "string",
			"const": "2.0"
		},
		"workflow_mode": {
			"type": "string",
			"enum": ["parallel_dispatch", "subagent_task_execution", "mixed"]
		},
		"task_kind": {
			"type": "string",
			"enum": [
				"instruction_only",
				"research",
				"vcs_only",
				"single_file_edit",
				"multi_file_or_ambiguous_or_risky"
			]
		},
		"sizing": {
			"type": "object",
			"required": ["class", "rationale", "timebox_minutes"],
			"properties": {
				"class": {
					"type": "string",
					"enum": ["micro", "small", "medium", "large"]
				},
				"rationale": {
					"type": "string",
					"minLength": 1
				},
				"timebox_minutes": {
					"type": "integer",
					"minimum": 1
				}
			},
			"additionalProperties": false
		},
		"routing_decision": {
			"type": "string",
			"enum": ["micro_solo", "single_agent", "multi_agent"]
		},
		"ssot": {
			"type": "object",
			"required": ["goal", "non_goals", "constraints", "acceptance_criteria", "decisions"],
			"properties": {
				"goal": {
					"type": "string",
					"minLength": 1
				},
				"non_goals": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				},
				"constraints": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				},
				"acceptance_criteria": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				},
				"decisions": {
					"type": "array",
					"items": {
						"type": "string",
						"minLength": 1
					}
				}
			},
			"additionalProperties": false
		},
		"routing_mode": {
			"type": "string",
			"const": "assistant_nested"
		},
		"subtasks": {
			"type": "array",
			"minItems": 1,
			"items": {
				"type": "object",
				"required": [
					"task_id",
					"subtask_id",
					"type",
					"delegate_target",
					"allowed_paths",
					"deliverable"
				],
				"properties": {
					"task_id": {
						"type": "string",
						"minLength": 1
					},
					"subtask_id": {
						"type": "string",
						"minLength": 1
					},
					"type": {
						"type": "string",
						"enum": ["read_only", "write"]
					},
					"delegate_target": {
						"type": "string",
						"enum": ["auditor", "orchestrator"],
						"description": "Subtask delegation target. Use auditor for review/gate work; use orchestrator for execution/dispatch work."
					},
					"allowed_paths": {
						"type": "array",
						"minItems": 1,
						"items": {
							"type": "string",
							"minLength": 1,
							"pattern": "^(/|web:|repo:)"
						}
					},
					"deliverable": {
						"type": "string",
						"minLength": 1
					}
				},
				"additionalProperties": false
			}
		},
		"scheduler_plan": {
			"type": "string",
			"const": "windowed"
		},
		"review_policy": {
			"type": "object",
			"required": ["phase_order", "auditor_passes_target", "auditor_passes_max"],
			"properties": {
				"phase_order": {
					"type": "array",
					"minItems": 2,
					"prefixItems": [
						{
							"type": "string",
							"const": "spec"
						},
						{
							"type": "string",
							"const": "quality"
						}
					],
					"items": false
				},
				"auditor_passes_target": {
					"type": "integer",
					"const": 2
				},
				"auditor_passes_max": {
					"type": "integer",
					"const": 3
				}
			},
			"additionalProperties": false
		},
		"parallel_policy": {
			"type": "object",
			"required": ["scheduler_plan", "wait_strategy", "conflict_policy", "window_size"],
			"properties": {
				"scheduler_plan": {
					"type": "string",
					"const": "windowed"
				},
				"wait_strategy": {
					"type": "string",
					"const": "wait_any"
				},
				"conflict_policy": {
					"type": "string",
					"const": "ownership_lock"
				},
				"window_size": {
					"type": "integer",
					"minimum": 1
				}
			},
			"additionalProperties": false
		}
	},
	"allOf": [
		{
			"if": {
				"properties": {
					"task_kind": {
						"enum": ["instruction_only", "vcs_only", "single_file_edit"]
					}
				}
			},
			"then": {
				"properties": {
					"routing_decision": { "const": "micro_solo" },
					"sizing": { "properties": { "class": { "enum": ["micro", "small"] } } },
					"parallel_policy": { "properties": { "window_size": { "const": 1 } } }
				}
			}
		},
		{
			"if": {
				"properties": {
					"task_kind": { "const": "multi_file_or_ambiguous_or_risky" }
				}
			},
			"then": {
				"properties": {
					"routing_decision": { "const": "multi_agent" },
					"sizing": { "properties": { "class": { "enum": ["medium", "large"] } } }
				}
			}
		},
		{
			"if": {
				"properties": {
					"routing_decision": { "enum": ["micro_solo", "single_agent"] }
				}
			},
			"then": {
				"properties": {
					"parallel_policy": { "properties": { "window_size": { "const": 1 } } }
				}
			}
		}
	],
	"examples": [
		{
			"ssot_id": "dev-9f2c0d6a1b3e",
			"protocol_version": "2.0",
			"workflow_mode": "mixed",
			"task_kind": "multi_file_or_ambiguous_or_risky",
			"sizing": {
				"class": "medium",
				"rationale": "Multi-file protocol/schema changes with review gates and validation evidence required.",
				"timebox_minutes": 30
			},
			"routing_decision": "multi_agent",
			"ssot": {
				"goal": "Apply requested file updates with Auditor-gated Orchestrator execution and evidence-backed verification.",
				"non_goals": ["No unrelated refactors"],
				"constraints": [
					"SSOT frozen during execution",
					"Director spawns Auditor and Orchestrator as peers; Orchestrator delegates to leaf agents; Auditor gates Orchestrator output."
				],
				"acceptance_criteria": [
					"Schema-valid director/auditor/orchestrator chain outputs",
					"Requested files updated"
				],
				"decisions": [
					"Use depth=2 peer-spawn topology: Director -> (Auditor | Orchestrator) -> leaf"
				]
			},
			"routing_mode": "assistant_nested",
			"subtasks": [
				{
					"task_id": "task-brief-001",
					"subtask_id": "s1-brief",
					"type": "read_only",
					"delegate_target": "auditor",
					"allowed_paths": ["/abs/repo"],
					"deliverable": "Coder-ready execution brief."
				},
				{
					"task_id": "task-write-001",
					"subtask_id": "s2-write",
					"type": "write",
					"delegate_target": "orchestrator",
					"allowed_paths": ["/abs/repo/path/file.md"],
					"deliverable": "Auditor/Orchestrator-reviewed Coder execution with evidence."
				}
			],
			"scheduler_plan": "windowed",
			"review_policy": {
				"phase_order": ["spec", "quality"],
				"auditor_passes_target": 2,
				"auditor_passes_max": 3
			},
			"parallel_policy": {
				"scheduler_plan": "windowed",
				"wait_strategy": "wait_any",
				"conflict_policy": "ownership_lock",
				"window_size": 2
			}
		}
	],
	"additionalProperties": false
}
