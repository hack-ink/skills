{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "file:///.codex/agent-output-auditor-write.schema.json",
	"title": "Codex Auditor Output (Write)",
	"description": "Structural schema for auditor outputs that report completion of write subtasks. Write workflows may dispatch a mix of coding Coder slices and non-coding Operator slices.",
	"type": "object",
	"required": [
		"ssot_id",
		"protocol_version",
		"task_id",
		"subtask_id",
		"agent_type",
		"workflow_mode",
		"routing_mode",
		"slice_id",
		"coder_subtask_ids",
		"operator_subtask_ids",
		"parallel_peak_inflight",
		"audit_phases",
		"diff_review",
		"status",
		"blocked",
		"rationale",
		"review_only",
		"blocking_reason",
		"validation_evidence",
		"allowed_paths",
		"review_loop"
	],
	"$defs": {
		"finding": {
			"type": "object",
			"required": ["severity", "title", "details", "action_required"],
			"properties": {
				"severity": {
					"type": "string",
					"enum": ["critical", "important", "minor"]
				},
				"title": {
					"type": "string",
					"minLength": 1
				},
				"details": {
					"type": "string",
					"minLength": 1
				},
				"action_required": {
					"type": "boolean"
				}
			},
			"additionalProperties": false
		},
		"audit_phase_base": {
			"type": "object",
			"required": ["phase", "status", "findings", "evidence"],
			"properties": {
				"phase": {
					"type": "string",
					"enum": ["spec", "quality"]
				},
				"status": {
					"type": "string",
					"enum": ["pass", "fail"]
				},
				"findings": {
					"type": "array",
					"items": {
						"$ref": "#/$defs/finding"
					}
				},
				"evidence": {
					"type": "string",
					"minLength": 1
				}
			},
			"additionalProperties": false
		},
		"audit_phase_spec": {
			"allOf": [
				{
					"$ref": "#/$defs/audit_phase_base"
				},
				{
					"properties": {
						"phase": {
							"const": "spec"
						}
					}
				}
			]
		},
		"audit_phase_quality": {
			"allOf": [
				{
					"$ref": "#/$defs/audit_phase_base"
				},
				{
					"properties": {
						"phase": {
							"const": "quality"
						}
					}
				}
			]
		}
	},
	"properties": {
		"ssot_id": {
			"type": "string",
			"minLength": 1
		},
		"protocol_version": {
			"type": "string",
			"const": "2.0"
		},
		"task_id": {
			"type": "string",
			"minLength": 1
		},
		"subtask_id": {
			"type": "string",
			"minLength": 1
		},
		"agent_type": {
			"type": "string",
			"const": "auditor"
		},
		"workflow_mode": {
			"type": "string",
			"enum": ["parallel_dispatch", "subagent_task_execution", "mixed"]
		},
		"routing_mode": {
			"type": "string",
			"const": "assistant_nested"
		},
		"slice_id": {
			"type": "string",
			"minLength": 1
		},
		"coder_subtask_ids": {
			"type": "array",
			"minItems": 1,
			"items": {
				"type": "string",
				"minLength": 1
			}
		},
		"operator_subtask_ids": {
			"type": "array",
			"items": {
				"type": "string",
				"minLength": 1
			}
		},
		"parallel_peak_inflight": {
			"type": "integer",
			"minimum": 1
		},
		"audit_phases": {
			"type": "array",
			"minItems": 2,
			"maxItems": 2,
			"prefixItems": [
				{
					"$ref": "#/$defs/audit_phase_spec"
				},
				{
					"$ref": "#/$defs/audit_phase_quality"
				}
			],
			"items": false
		},
		"diff_review": {
			"type": "object",
			"required": ["status", "base_ref", "head_ref", "command", "evidence"],
			"properties": {
				"status": {
					"type": "string",
					"enum": ["pass", "fail"]
				},
				"base_ref": {
					"allOf": [
						{ "type": "string", "minLength": 1 },
						{ "not": { "const": "not_applicable" } }
					]
				},
				"head_ref": {
					"allOf": [
						{ "type": "string", "minLength": 1 },
						{ "not": { "const": "not_applicable" } }
					]
				},
				"command": {
					"allOf": [
						{ "type": "string", "minLength": 1 },
						{ "not": { "const": "not_applicable" } }
					]
				},
				"evidence": {
					"allOf": [
						{ "type": "string", "minLength": 1 },
						{ "not": { "const": "not_applicable" } }
					]
				}
			},
			"additionalProperties": false
		},
		"status": {
			"type": "string",
			"enum": ["in_progress", "done", "awaiting_review"]
		},
		"blocked": {
			"type": "boolean"
		},
		"rationale": {
			"type": "string",
			"minLength": 1
		},
		"review_only": {
			"type": "boolean"
		},
		"blocking_reason": {
			"type": "string",
			"minLength": 1
		},
		"validation_evidence": {
			"type": "string",
			"minLength": 1
		},
		"allowed_paths": {
			"type": "array",
			"minItems": 1,
			"items": {
				"type": "string",
				"minLength": 1,
				"pattern": "^(/|web:|repo:)"
			}
		},
		"review_loop": {
			"type": "object",
			"required": [
				"policy",
				"auditor_passes",
				"orchestrator_self_passes",
				"converged",
				"new_issues_found_in_last_audit_pass",
				"escalation_reason"
			],
			"properties": {
				"policy": {
					"type": "string",
					"const": "adaptive_min2_max3_second_pass_stable"
				},
				"auditor_passes": {
					"type": "integer",
					"minimum": 2,
					"maximum": 3
				},
				"orchestrator_self_passes": {
					"type": "integer",
					"minimum": 2
				},
				"converged": {
					"type": "boolean"
				},
				"new_issues_found_in_last_audit_pass": {
					"type": "boolean"
				},
				"escalation_reason": {
					"type": "string",
					"minLength": 1
				}
			},
			"additionalProperties": false
		}
	},
	"allOf": [
		{
			"oneOf": [
				{
					"properties": {
						"status": {
							"const": "awaiting_review"
						},
						"blocked": {
							"const": true
						}
					}
				},
				{
					"allOf": [
						{
							"properties": {
								"status": {
									"enum": ["in_progress", "done"]
								}
							}
						},
						{
							"properties": {
								"blocked": {
									"const": false
								}
							}
						}
					]
				}
			]
		},
		{
			"if": { "properties": { "blocked": { "const": false } } },
			"then": { "properties": { "blocking_reason": { "const": "not_applicable" } } }
		},
		{
			"if": { "properties": { "blocked": { "const": true } } },
			"then": {
				"properties": { "blocking_reason": { "not": { "const": "not_applicable" } } }
			}
		},
		{
			"if": { "properties": { "status": { "const": "done" } } },
			"then": {
				"properties": {
					"review_loop": { "properties": { "converged": { "const": true } } }
				}
			}
		}
	],
	"examples": [
		{
			"ssot_id": "dev-0001",
			"protocol_version": "2.0",
			"task_id": "task-write-001",
			"subtask_id": "s2-write",
			"agent_type": "auditor",
			"workflow_mode": "mixed",
			"routing_mode": "assistant_nested",
			"slice_id": "slice-audit-write-a",
			"coder_subtask_ids": ["coder-1", "coder-2"],
			"operator_subtask_ids": [],
			"parallel_peak_inflight": 2,
			"audit_phases": [
				{
					"phase": "spec",
					"status": "pass",
					"findings": [],
					"evidence": "Spec: contract scope/constraints matched; no extra work detected."
				},
				{
					"phase": "quality",
					"status": "pass",
					"findings": [],
					"evidence": "Quality: evidence present; ownership and integration checks satisfied."
				}
			],
			"diff_review": {
				"status": "pass",
				"base_ref": "HEAD~1",
				"head_ref": "HEAD",
				"command": "git diff --stat HEAD~1..HEAD",
				"evidence": "0 files changed"
			},
			"status": "done",
			"blocked": false,
			"rationale": "Auditor completed spec-first then quality review and accepted the result.",
			"review_only": false,
			"blocking_reason": "not_applicable",
			"validation_evidence": "Auditor independently validated coder outputs and required review phases.",
			"allowed_paths": ["/abs/runtime/.codex/AGENTS.md"],
			"review_loop": {
				"policy": "adaptive_min2_max3_second_pass_stable",
				"auditor_passes": 2,
				"orchestrator_self_passes": 2,
				"converged": true,
				"new_issues_found_in_last_audit_pass": false,
				"escalation_reason": "none"
			}
		}
	],
	"additionalProperties": false
}
